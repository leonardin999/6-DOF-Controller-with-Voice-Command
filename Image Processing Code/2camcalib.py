# -*- coding: utf-8 -*-
"""
Created on Fri Jun 11 08:31:10 2021

@author: TungLinh
"""

import cv2
import numpy as np
from math import atan, pi, fabs, sqrt, tan, e
import pandas as pd
import threading
from time import sleep
import imutils
import keyboard  




def Rotation_matrix(tx,ty,tz,xd,yd,zd):
    Rx = np.matrix([[1              , 0             , 0             ] ,
                    [0              , np.cos(tx)    , -np.sin(tx)   ] ,
                    [0              , np.sin(tx)    , np.cos(tx)    ]])
    
    Ry = np.matrix([[np.cos(ty)     , 0             , np.sin(ty)    ] ,
                    [0              , 1             , 0             ] ,
                    [-np.sin(ty)    , 0             , np.cos(ty)    ]])
    
    Rz = np.matrix([[np.cos(tz)     , -np.sin(tz)   , 0             ] ,
                    [np.sin(tz)     , np.cos(tz)    , 0             ] ,
                    [0              , 0             , 1             ]])

    R0EE = np.dot(np.dot(Rx , Ry) , Rz)
    
    T0EE = np.matrix([[1       ,1      ,1      ,xd] ,
                      [1       ,1      ,1      ,yd] ,
                      [1       ,1      ,1      ,zd] ,
                      [0       ,0      ,0      ,1]])
    
    for i in range(3):
        for j in range(3):
            T0EE[i,j] = R0EE[i,j]
            
    return T0EE
    
    
def cam(threadname):
    global x
    global y
    global z
    global E
    
    global u1
    global v1
    global u2
    global v2


    while True: 
        try:
            ret0, img1 = cam1.read()
            h,  w = img1.shape[:2]
            newCameraMatrix, roi = cv2.getOptimalNewCameraMatrix(cameraMatrix1, dist1, (w,h), 1, (w,h))
            img1 = cv2.undistort(img1, cameraMatrix1, dist1, None, newCameraMatrix)
            
            ret1, img2 = cam2.read()
            newCameraMatrix, roi = cv2.getOptimalNewCameraMatrix(cameraMatrix2, dist2, (w,h), 1, (w,h))
            img2 = cv2.undistort(img2, cameraMatrix2, dist2, None, newCameraMatrix)
           
            P = "toa do: " + str(np.round(X,4)) + ' ' + str(np.round(Y,4)) + ' ' + str(np.round(Z,4)) + ' ' + str(np.round(E,16))

            if(ret0):
                gray = cv2.cvtColor(img1, cv2.COLOR_BGR2GRAY)
                blurred = cv2.GaussianBlur(gray, (5, 5), 0)
                can = cv2.Canny(blurred, 15,70)
                cnts = cv2.findContours(can, cv2.RETR_EXTERNAL,cv2.CHAIN_APPROX_SIMPLE)
                cnts = imutils.grab_contours(cnts)
                
                for C in cnts:
                    area1 = cv2.contourArea(C)
                    if area1 > 1000 and area1 < 10000:
                        cv2.drawContours(img1, [C], -1, (0,255,0), 2)  
                        M = cv2.moments(C)
                        u1= int(M["m10"]/ M["m00"])
                        v1= int(M["m01"]/ M["m00"])
                        cv2.circle(img1, (u1,v1), 2, (0, 0, 255), -2)
                        cv2.putText(img1, str(u1) + ' '+ str(v1), (u1 - 20, v1 - 20), cv2.FONT_HERSHEY_SIMPLEX, 0.5, (255, 0, 0), 2)
                cv2.putText(img1,P,(20,20), cv2.FONT_HERSHEY_SIMPLEX, 0.5, (255,0,0),1)  
                cv2.imshow('cam1', img1)    
            if(ret1):
                gray = cv2.cvtColor(img2, cv2.COLOR_BGR2GRAY)
                blurred = cv2.GaussianBlur(gray, (5, 5), 0)
                can = cv2.Canny(blurred, 15,70)
                cnts = cv2.findContours(can, cv2.RETR_EXTERNAL,cv2.CHAIN_APPROX_SIMPLE)
                cnts = imutils.grab_contours(cnts)
               
          # xac dinh toa do
                for C in cnts:
                    area2 = cv2.contourArea(C)
                    if area2 > 1000 and area2 < 10000:
                        cv2.drawContours(img2, [C], -1, (0,255,0), 2)  
                        M = cv2.moments(C)
                        u2= int(M["m10"]/ M["m00"])
                        v2= int(M["m01"]/ M["m00"])
                        cv2.circle(img2, (u2,v2), 2, (0, 0, 255), -2)
                        cv2.putText(img2, str(u2) + ' '+ str(v2), (u2 - 20, v2 - 20), cv2.FONT_HERSHEY_SIMPLEX, 0.5, (255, 0, 0), 2) 
                cv2.putText(img2,P,(20,20), cv2.FONT_HERSHEY_SIMPLEX, 0.5, (255,0,0),1)  
                cv2.imshow('cam2', img2)    
            if cv2.waitKey(1) & 0xFF == 27:
                print('stop thread 1')
                break
        except:
            print('Loading1...')
    cam1.release()
    cam2.release()
    cv2.destroyAllWindows()
       
    
def process(threadname):
    global X
    global Y
    global Z
    global E

    global m1t
    global m2t 
    global m3t
    global v1t 
    global v2t
    global v3t 
    
    global u1
    global v1
    global u2
    global v2
    
    while True:
        try:
            '''
            U1d = (u1-640)*2.8*10**(-6)
            V1d = (v1-360)*2.8*10**(-6)
            U2d = (u2-640)*2.8*10**(-6)
            V2d = (v2-360)*2.8*10**(-6)
            
            P_0_EE = np.matrix([[X],[Y],[Z],[1]])
            
            P_C1_EE = np.dot(np.linalg.inv(T_0_C1),P_0_EE) 
            P_C2_EE = np.dot(np.linalg.inv(T_0_C2),P_0_EE) 
            
            X1 = P_C1_EE[0,0]
            Y1 = P_C1_EE[1,0]
            Z1 = P_C1_EE[2,0]
            
            X2 = P_C2_EE[0,0]
            Y2 = P_C2_EE[1,0]
            Z2 = P_C2_EE[2,0]
        
            U1 = X1*f1x/Z1
            V1 = Y1*f1y/Z1
            
            U2 = X2*f2x/Z2
            V2 = Y2*f2y/Z2
        
            E = 0.5*(U1 - U1d)**2 + 0.5*(V1 - V1d)**2 + 0.5*(U2 - U2d)**2 + 0.5*(V2 - V2d)**2
            
            dx = (U1 - U1d)*(- (f1x*np.sin(ty1)*((Y*(np.cos(tx1)*np.sin(tz1)*np.cos(ty1)**2 + np.cos(tx1)*np.sin(tz1)*np.sin(ty1)**2 + np.cos(tz1)*np.sin(tx1)*np.sin(ty1)))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) - (yd1*np.cos(tz1)*np.sin(tx1)*np.sin(ty1) - zd1*np.cos(tx1)*np.cos(tz1)*np.sin(ty1) + xd1*np.cos(tx1)**2*np.cos(ty1)*np.cos(tz1) + xd1*np.cos(ty1)*np.cos(tz1)*np.sin(tx1)**2 + yd1*np.cos(tx1)*np.cos(ty1)**2*np.sin(tz1) + yd1*np.cos(tx1)*np.sin(ty1)**2*np.sin(tz1) + zd1*np.cos(ty1)**2*np.sin(tx1)*np.sin(tz1) + zd1*np.sin(tx1)*np.sin(ty1)**2*np.sin(tz1))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) + (Z*(np.sin(tx1)*np.sin(tz1)*np.cos(ty1)**2 + np.sin(tx1)*np.sin(tz1)*np.sin(ty1)**2 - np.cos(tx1)*np.cos(tz1)*np.sin(ty1)))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) + (X*np.cos(ty1)*np.cos(tz1))/(np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(ty1)**2 + np.sin(ty1)**2*np.sin(tz1)**2)))/((np.cos(ty1)**2 + np.sin(ty1)**2)*((xd1*np.sin(ty1)*np.cos(tx1)**2 + zd1*np.cos(ty1)*np.cos(tx1) + xd1*np.sin(ty1)*np.sin(tx1)**2 - yd1*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) - (X*np.sin(ty1))/(np.cos(ty1)**2 + np.sin(ty1)**2) - (Z*np.cos(tx1)*np.cos(ty1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) + (Y*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2))**2) - (f1x*np.cos(ty1)*np.cos(tz1))/(((xd1*np.sin(ty1)*np.cos(tx1)**2 + zd1*np.cos(ty1)*np.cos(tx1) + xd1*np.sin(ty1)*np.sin(tx1)**2 - yd1*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) - (X*np.sin(ty1))/(np.cos(ty1)**2 + np.sin(ty1)**2) - (Z*np.cos(tx1)*np.cos(ty1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) + (Y*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2))*(np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(ty1)**2 + np.sin(ty1)**2*np.sin(tz1)**2))) + (V1 - V1d)*((f1y*np.sin(ty1)*((- xd1*np.sin(tz1)*np.cos(tx1)**2*np.cos(ty1) + yd1*np.cos(tz1)*np.cos(tx1)*np.cos(ty1)**2 + yd1*np.cos(tz1)*np.cos(tx1)*np.sin(ty1)**2 + zd1*np.sin(tz1)*np.cos(tx1)*np.sin(ty1) + zd1*np.cos(tz1)*np.cos(ty1)**2*np.sin(tx1) - xd1*np.sin(tz1)*np.cos(ty1)*np.sin(tx1)**2 + zd1*np.cos(tz1)*np.sin(tx1)*np.sin(ty1)**2 - yd1*np.sin(tz1)*np.sin(tx1)*np.sin(ty1))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) - (Y*(np.cos(tx1)*np.cos(ty1)**2*np.cos(tz1) - np.sin(tx1)*np.sin(ty1)*np.sin(tz1) + np.cos(tx1)*np.cos(tz1)*np.sin(ty1)**2))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) - (Z*(np.cos(tz1)*np.sin(tx1)*np.cos(ty1)**2 + np.cos(tz1)*np.sin(tx1)*np.sin(ty1)**2 + np.cos(tx1)*np.sin(tz1)*np.sin(ty1)))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) + (X*np.cos(ty1)*np.sin(tz1))/(np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(ty1)**2 + np.sin(ty1)**2*np.sin(tz1)**2)))/((np.cos(ty1)**2 + np.sin(ty1)**2)*((xd1*np.sin(ty1)*np.cos(tx1)**2 + zd1*np.cos(ty1)*np.cos(tx1) + xd1*np.sin(ty1)*np.sin(tx1)**2 - yd1*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) - (X*np.sin(ty1))/(np.cos(ty1)**2 + np.sin(ty1)**2) - (Z*np.cos(tx1)*np.cos(ty1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) + (Y*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2))**2) + (f1y*np.cos(ty1)*np.sin(tz1))/(((xd1*np.sin(ty1)*np.cos(tx1)**2 + zd1*np.cos(ty1)*np.cos(tx1) + xd1*np.sin(ty1)*np.sin(tx1)**2 - yd1*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) - (X*np.sin(ty1))/(np.cos(ty1)**2 + np.sin(ty1)**2) - (Z*np.cos(tx1)*np.cos(ty1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) + (Y*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2))*(np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(ty1)**2 + np.sin(ty1)**2*np.sin(tz1)**2))) + (U2 - U2d)*(- (f2x*np.sin(ty2)*((Y*(np.cos(tx2)*np.sin(tz2)*np.cos(ty2)**2 + np.cos(tx2)*np.sin(tz2)*np.sin(ty2)**2 + np.cos(tz2)*np.sin(tx2)*np.sin(ty2)))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) - (yd2*np.cos(tz2)*np.sin(tx2)*np.sin(ty2) - zd2*np.cos(tx2)*np.cos(tz2)*np.sin(ty2) + xd2*np.cos(tx2)**2*np.cos(ty2)*np.cos(tz2) + xd2*np.cos(ty2)*np.cos(tz2)*np.sin(tx2)**2 + yd2*np.cos(tx2)*np.cos(ty2)**2*np.sin(tz2) + yd2*np.cos(tx2)*np.sin(ty2)**2*np.sin(tz2) + zd2*np.cos(ty2)**2*np.sin(tx2)*np.sin(tz2) + zd2*np.sin(tx2)*np.sin(ty2)**2*np.sin(tz2))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) + (Z*(np.sin(tx2)*np.sin(tz2)*np.cos(ty2)**2 + np.sin(tx2)*np.sin(tz2)*np.sin(ty2)**2 - np.cos(tx2)*np.cos(tz2)*np.sin(ty2)))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) + (X*np.cos(ty2)*np.cos(tz2))/(np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(ty2)**2 + np.sin(ty2)**2*np.sin(tz2)**2)))/((np.cos(ty2)**2 + np.sin(ty2)**2)*((xd2*np.sin(ty2)*np.cos(tx2)**2 + zd2*np.cos(ty2)*np.cos(tx2) + xd2*np.sin(ty2)*np.sin(tx2)**2 - yd2*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) - (X*np.sin(ty2))/(np.cos(ty2)**2 + np.sin(ty2)**2) - (Z*np.cos(tx2)*np.cos(ty2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) + (Y*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2))**2) - (f2x*np.cos(ty2)*np.cos(tz2))/(((xd2*np.sin(ty2)*np.cos(tx2)**2 + zd2*np.cos(ty2)*np.cos(tx2) + xd2*np.sin(ty2)*np.sin(tx2)**2 - yd2*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) - (X*np.sin(ty2))/(np.cos(ty2)**2 + np.sin(ty2)**2) - (Z*np.cos(tx2)*np.cos(ty2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) + (Y*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2))*(np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(ty2)**2 + np.sin(ty2)**2*np.sin(tz2)**2))) + (V2 - V2d)*((f2y*np.sin(ty2)*((- xd2*np.sin(tz2)*np.cos(tx2)**2*np.cos(ty2) + yd2*np.cos(tz2)*np.cos(tx2)*np.cos(ty2)**2 + yd2*np.cos(tz2)*np.cos(tx2)*np.sin(ty2)**2 + zd2*np.sin(tz2)*np.cos(tx2)*np.sin(ty2) + zd2*np.cos(tz2)*np.cos(ty2)**2*np.sin(tx2) - xd2*np.sin(tz2)*np.cos(ty2)*np.sin(tx2)**2 + zd2*np.cos(tz2)*np.sin(tx2)*np.sin(ty2)**2 - yd2*np.sin(tz2)*np.sin(tx2)*np.sin(ty2))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) - (Y*(np.cos(tx2)*np.cos(ty2)**2*np.cos(tz2) - np.sin(tx2)*np.sin(ty2)*np.sin(tz2) + np.cos(tx2)*np.cos(tz2)*np.sin(ty2)**2))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) - (Z*(np.cos(tz2)*np.sin(tx2)*np.cos(ty2)**2 + np.cos(tz2)*np.sin(tx2)*np.sin(ty2)**2 + np.cos(tx2)*np.sin(tz2)*np.sin(ty2)))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) + (X*np.cos(ty2)*np.sin(tz2))/(np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(ty2)**2 + np.sin(ty2)**2*np.sin(tz2)**2)))/((np.cos(ty2)**2 + np.sin(ty2)**2)*((xd2*np.sin(ty2)*np.cos(tx2)**2 + zd2*np.cos(ty2)*np.cos(tx2) + xd2*np.sin(ty2)*np.sin(tx2)**2 - yd2*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) - (X*np.sin(ty2))/(np.cos(ty2)**2 + np.sin(ty2)**2) - (Z*np.cos(tx2)*np.cos(ty2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) + (Y*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2))**2) + (f2y*np.cos(ty2)*np.sin(tz2))/(((xd2*np.sin(ty2)*np.cos(tx2)**2 + zd2*np.cos(ty2)*np.cos(tx2) + xd2*np.sin(ty2)*np.sin(tx2)**2 - yd2*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) - (X*np.sin(ty2))/(np.cos(ty2)**2 + np.sin(ty2)**2) - (Z*np.cos(tx2)*np.cos(ty2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) + (Y*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2))*(np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(ty2)**2 + np.sin(ty2)**2*np.sin(tz2)**2)));
            dy = (U1 - U1d)*((f1x*np.cos(ty1)*np.sin(tx1)*((Y*(np.cos(tx1)*np.sin(tz1)*np.cos(ty1)**2 + np.cos(tx1)*np.sin(tz1)*np.sin(ty1)**2 + np.cos(tz1)*np.sin(tx1)*np.sin(ty1)))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) - (yd1*np.cos(tz1)*np.sin(tx1)*np.sin(ty1) - zd1*np.cos(tx1)*np.cos(tz1)*np.sin(ty1) + xd1*np.cos(tx1)**2*np.cos(ty1)*np.cos(tz1) + xd1*np.cos(ty1)*np.cos(tz1)*np.sin(tx1)**2 + yd1*np.cos(tx1)*np.cos(ty1)**2*np.sin(tz1) + yd1*np.cos(tx1)*np.sin(ty1)**2*np.sin(tz1) + zd1*np.cos(ty1)**2*np.sin(tx1)*np.sin(tz1) + zd1*np.sin(tx1)*np.sin(ty1)**2*np.sin(tz1))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) + (Z*(np.sin(tx1)*np.sin(tz1)*np.cos(ty1)**2 + np.sin(tx1)*np.sin(tz1)*np.sin(ty1)**2 - np.cos(tx1)*np.cos(tz1)*np.sin(ty1)))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) + (X*np.cos(ty1)*np.cos(tz1))/(np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(ty1)**2 + np.sin(ty1)**2*np.sin(tz1)**2)))/(((xd1*np.sin(ty1)*np.cos(tx1)**2 + zd1*np.cos(ty1)*np.cos(tx1) + xd1*np.sin(ty1)*np.sin(tx1)**2 - yd1*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) - (X*np.sin(ty1))/(np.cos(ty1)**2 + np.sin(ty1)**2) - (Z*np.cos(tx1)*np.cos(ty1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) + (Y*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2))**2*(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2)) - (f1x*(np.cos(tx1)*np.sin(tz1)*np.cos(ty1)**2 + np.cos(tx1)*np.sin(tz1)*np.sin(ty1)**2 + np.cos(tz1)*np.sin(tx1)*np.sin(ty1)))/(((xd1*np.sin(ty1)*np.cos(tx1)**2 + zd1*np.cos(ty1)*np.cos(tx1) + xd1*np.sin(ty1)*np.sin(tx1)**2 - yd1*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) - (X*np.sin(ty1))/(np.cos(ty1)**2 + np.sin(ty1)**2) - (Z*np.cos(tx1)*np.cos(ty1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) + (Y*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2))*(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2))) + (V1 - V1d)*(- (f1y*(np.cos(tx1)*np.cos(ty1)**2*np.cos(tz1) - np.sin(tx1)*np.sin(ty1)*np.sin(tz1) + np.cos(tx1)*np.cos(tz1)*np.sin(ty1)**2))/(((xd1*np.sin(ty1)*np.cos(tx1)**2 + zd1*np.cos(ty1)*np.cos(tx1) + xd1*np.sin(ty1)*np.sin(tx1)**2 - yd1*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) - (X*np.sin(ty1))/(np.cos(ty1)**2 + np.sin(ty1)**2) - (Z*np.cos(tx1)*np.cos(ty1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) + (Y*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2))*(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2)) - (f1y*np.cos(ty1)*np.sin(tx1)*((- xd1*np.sin(tz1)*np.cos(tx1)**2*np.cos(ty1) + yd1*np.cos(tz1)*np.cos(tx1)*np.cos(ty1)**2 + yd1*np.cos(tz1)*np.cos(tx1)*np.sin(ty1)**2 + zd1*np.sin(tz1)*np.cos(tx1)*np.sin(ty1) + zd1*np.cos(tz1)*np.cos(ty1)**2*np.sin(tx1) - xd1*np.sin(tz1)*np.cos(ty1)*np.sin(tx1)**2 + zd1*np.cos(tz1)*np.sin(tx1)*np.sin(ty1)**2 - yd1*np.sin(tz1)*np.sin(tx1)*np.sin(ty1))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) - (Y*(np.cos(tx1)*np.cos(ty1)**2*np.cos(tz1) - np.sin(tx1)*np.sin(ty1)*np.sin(tz1) + np.cos(tx1)*np.cos(tz1)*np.sin(ty1)**2))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) - (Z*(np.cos(tz1)*np.sin(tx1)*np.cos(ty1)**2 + np.cos(tz1)*np.sin(tx1)*np.sin(ty1)**2 + np.cos(tx1)*np.sin(tz1)*np.sin(ty1)))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) + (X*np.cos(ty1)*np.sin(tz1))/(np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(ty1)**2 + np.sin(ty1)**2*np.sin(tz1)**2)))/(((xd1*np.sin(ty1)*np.cos(tx1)**2 + zd1*np.cos(ty1)*np.cos(tx1) + xd1*np.sin(ty1)*np.sin(tx1)**2 - yd1*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) - (X*np.sin(ty1))/(np.cos(ty1)**2 + np.sin(ty1)**2) - (Z*np.cos(tx1)*np.cos(ty1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) + (Y*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2))**2*(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2))) + (U2 - U2d)*((f2x*np.cos(ty2)*np.sin(tx2)*((Y*(np.cos(tx2)*np.sin(tz2)*np.cos(ty2)**2 + np.cos(tx2)*np.sin(tz2)*np.sin(ty2)**2 + np.cos(tz2)*np.sin(tx2)*np.sin(ty2)))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) - (yd2*np.cos(tz2)*np.sin(tx2)*np.sin(ty2) - zd2*np.cos(tx2)*np.cos(tz2)*np.sin(ty2) + xd2*np.cos(tx2)**2*np.cos(ty2)*np.cos(tz2) + xd2*np.cos(ty2)*np.cos(tz2)*np.sin(tx2)**2 + yd2*np.cos(tx2)*np.cos(ty2)**2*np.sin(tz2) + yd2*np.cos(tx2)*np.sin(ty2)**2*np.sin(tz2) + zd2*np.cos(ty2)**2*np.sin(tx2)*np.sin(tz2) + zd2*np.sin(tx2)*np.sin(ty2)**2*np.sin(tz2))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) + (Z*(np.sin(tx2)*np.sin(tz2)*np.cos(ty2)**2 + np.sin(tx2)*np.sin(tz2)*np.sin(ty2)**2 - np.cos(tx2)*np.cos(tz2)*np.sin(ty2)))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) + (X*np.cos(ty2)*np.cos(tz2))/(np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(ty2)**2 + np.sin(ty2)**2*np.sin(tz2)**2)))/(((xd2*np.sin(ty2)*np.cos(tx2)**2 + zd2*np.cos(ty2)*np.cos(tx2) + xd2*np.sin(ty2)*np.sin(tx2)**2 - yd2*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) - (X*np.sin(ty2))/(np.cos(ty2)**2 + np.sin(ty2)**2) - (Z*np.cos(tx2)*np.cos(ty2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) + (Y*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2))**2*(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2)) - (f2x*(np.cos(tx2)*np.sin(tz2)*np.cos(ty2)**2 + np.cos(tx2)*np.sin(tz2)*np.sin(ty2)**2 + np.cos(tz2)*np.sin(tx2)*np.sin(ty2)))/(((xd2*np.sin(ty2)*np.cos(tx2)**2 + zd2*np.cos(ty2)*np.cos(tx2) + xd2*np.sin(ty2)*np.sin(tx2)**2 - yd2*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) - (X*np.sin(ty2))/(np.cos(ty2)**2 + np.sin(ty2)**2) - (Z*np.cos(tx2)*np.cos(ty2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) + (Y*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2))*(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2))) + (V2 - V2d)*(- (f2y*(np.cos(tx2)*np.cos(ty2)**2*np.cos(tz2) - np.sin(tx2)*np.sin(ty2)*np.sin(tz2) + np.cos(tx2)*np.cos(tz2)*np.sin(ty2)**2))/(((xd2*np.sin(ty2)*np.cos(tx2)**2 + zd2*np.cos(ty2)*np.cos(tx2) + xd2*np.sin(ty2)*np.sin(tx2)**2 - yd2*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) - (X*np.sin(ty2))/(np.cos(ty2)**2 + np.sin(ty2)**2) - (Z*np.cos(tx2)*np.cos(ty2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) + (Y*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2))*(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2)) - (f2y*np.cos(ty2)*np.sin(tx2)*((- xd2*np.sin(tz2)*np.cos(tx2)**2*np.cos(ty2) + yd2*np.cos(tz2)*np.cos(tx2)*np.cos(ty2)**2 + yd2*np.cos(tz2)*np.cos(tx2)*np.sin(ty2)**2 + zd2*np.sin(tz2)*np.cos(tx2)*np.sin(ty2) + zd2*np.cos(tz2)*np.cos(ty2)**2*np.sin(tx2) - xd2*np.sin(tz2)*np.cos(ty2)*np.sin(tx2)**2 + zd2*np.cos(tz2)*np.sin(tx2)*np.sin(ty2)**2 - yd2*np.sin(tz2)*np.sin(tx2)*np.sin(ty2))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) - (Y*(np.cos(tx2)*np.cos(ty2)**2*np.cos(tz2) - np.sin(tx2)*np.sin(ty2)*np.sin(tz2) + np.cos(tx2)*np.cos(tz2)*np.sin(ty2)**2))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) - (Z*(np.cos(tz2)*np.sin(tx2)*np.cos(ty2)**2 + np.cos(tz2)*np.sin(tx2)*np.sin(ty2)**2 + np.cos(tx2)*np.sin(tz2)*np.sin(ty2)))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) + (X*np.cos(ty2)*np.sin(tz2))/(np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(ty2)**2 + np.sin(ty2)**2*np.sin(tz2)**2)))/(((xd2*np.sin(ty2)*np.cos(tx2)**2 + zd2*np.cos(ty2)*np.cos(tx2) + xd2*np.sin(ty2)*np.sin(tx2)**2 - yd2*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) - (X*np.sin(ty2))/(np.cos(ty2)**2 + np.sin(ty2)**2) - (Z*np.cos(tx2)*np.cos(ty2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) + (Y*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2))**2*(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2)));
            dz = (U1 - U1d)*(- (f1x*(np.sin(tx1)*np.sin(tz1)*np.cos(ty1)**2 + np.sin(tx1)*np.sin(tz1)*np.sin(ty1)**2 - np.cos(tx1)*np.cos(tz1)*np.sin(ty1)))/(((xd1*np.sin(ty1)*np.cos(tx1)**2 + zd1*np.cos(ty1)*np.cos(tx1) + xd1*np.sin(ty1)*np.sin(tx1)**2 - yd1*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) - (X*np.sin(ty1))/(np.cos(ty1)**2 + np.sin(ty1)**2) - (Z*np.cos(tx1)*np.cos(ty1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) + (Y*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2))*(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2)) - (f1x*np.cos(tx1)*np.cos(ty1)*((Y*(np.cos(tx1)*np.sin(tz1)*np.cos(ty1)**2 + np.cos(tx1)*np.sin(tz1)*np.sin(ty1)**2 + np.cos(tz1)*np.sin(tx1)*np.sin(ty1)))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) - (yd1*np.cos(tz1)*np.sin(tx1)*np.sin(ty1) - zd1*np.cos(tx1)*np.cos(tz1)*np.sin(ty1) + xd1*np.cos(tx1)**2*np.cos(ty1)*np.cos(tz1) + xd1*np.cos(ty1)*np.cos(tz1)*np.sin(tx1)**2 + yd1*np.cos(tx1)*np.cos(ty1)**2*np.sin(tz1) + yd1*np.cos(tx1)*np.sin(ty1)**2*np.sin(tz1) + zd1*np.cos(ty1)**2*np.sin(tx1)*np.sin(tz1) + zd1*np.sin(tx1)*np.sin(ty1)**2*np.sin(tz1))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) + (Z*(np.sin(tx1)*np.sin(tz1)*np.cos(ty1)**2 + np.sin(tx1)*np.sin(tz1)*np.sin(ty1)**2 - np.cos(tx1)*np.cos(tz1)*np.sin(ty1)))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) + (X*np.cos(ty1)*np.cos(tz1))/(np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(ty1)**2 + np.sin(ty1)**2*np.sin(tz1)**2)))/(((xd1*np.sin(ty1)*np.cos(tx1)**2 + zd1*np.cos(ty1)*np.cos(tx1) + xd1*np.sin(ty1)*np.sin(tx1)**2 - yd1*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) - (X*np.sin(ty1))/(np.cos(ty1)**2 + np.sin(ty1)**2) - (Z*np.cos(tx1)*np.cos(ty1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) + (Y*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2))**2*(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2))) + (V1 - V1d)*((f1y*np.cos(tx1)*np.cos(ty1)*((- xd1*np.sin(tz1)*np.cos(tx1)**2*np.cos(ty1) + yd1*np.cos(tz1)*np.cos(tx1)*np.cos(ty1)**2 + yd1*np.cos(tz1)*np.cos(tx1)*np.sin(ty1)**2 + zd1*np.sin(tz1)*np.cos(tx1)*np.sin(ty1) + zd1*np.cos(tz1)*np.cos(ty1)**2*np.sin(tx1) - xd1*np.sin(tz1)*np.cos(ty1)*np.sin(tx1)**2 + zd1*np.cos(tz1)*np.sin(tx1)*np.sin(ty1)**2 - yd1*np.sin(tz1)*np.sin(tx1)*np.sin(ty1))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) - (Y*(np.cos(tx1)*np.cos(ty1)**2*np.cos(tz1) - np.sin(tx1)*np.sin(ty1)*np.sin(tz1) + np.cos(tx1)*np.cos(tz1)*np.sin(ty1)**2))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) - (Z*(np.cos(tz1)*np.sin(tx1)*np.cos(ty1)**2 + np.cos(tz1)*np.sin(tx1)*np.sin(ty1)**2 + np.cos(tx1)*np.sin(tz1)*np.sin(ty1)))/(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2) + (X*np.cos(ty1)*np.sin(tz1))/(np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(ty1)**2 + np.sin(ty1)**2*np.sin(tz1)**2)))/(((xd1*np.sin(ty1)*np.cos(tx1)**2 + zd1*np.cos(ty1)*np.cos(tx1) + xd1*np.sin(ty1)*np.sin(tx1)**2 - yd1*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) - (X*np.sin(ty1))/(np.cos(ty1)**2 + np.sin(ty1)**2) - (Z*np.cos(tx1)*np.cos(ty1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) + (Y*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2))**2*(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2)) - (f1y*(np.cos(tz1)*np.sin(tx1)*np.cos(ty1)**2 + np.cos(tz1)*np.sin(tx1)*np.sin(ty1)**2 + np.cos(tx1)*np.sin(tz1)*np.sin(ty1)))/(((xd1*np.sin(ty1)*np.cos(tx1)**2 + zd1*np.cos(ty1)*np.cos(tx1) + xd1*np.sin(ty1)*np.sin(tx1)**2 - yd1*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) - (X*np.sin(ty1))/(np.cos(ty1)**2 + np.sin(ty1)**2) - (Z*np.cos(tx1)*np.cos(ty1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2) + (Y*np.cos(ty1)*np.sin(tx1))/(np.cos(tx1)**2*np.cos(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2 + np.cos(ty1)**2*np.sin(tx1)**2 + np.sin(tx1)**2*np.sin(ty1)**2))*(np.cos(tx1)**2*np.cos(ty1)**2*np.cos(tz1)**2 + np.cos(tx1)**2*np.cos(ty1)**2*np.sin(tz1)**2 + np.cos(tx1)**2*np.cos(tz1)**2*np.sin(ty1)**2 + np.cos(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2 + np.cos(ty1)**2*np.cos(tz1)**2*np.sin(tx1)**2 + np.cos(ty1)**2*np.sin(tx1)**2*np.sin(tz1)**2 + np.cos(tz1)**2*np.sin(tx1)**2*np.sin(ty1)**2 + np.sin(tx1)**2*np.sin(ty1)**2*np.sin(tz1)**2))) + (U2 - U2d)*(- (f2x*(np.sin(tx2)*np.sin(tz2)*np.cos(ty2)**2 + np.sin(tx2)*np.sin(tz2)*np.sin(ty2)**2 - np.cos(tx2)*np.cos(tz2)*np.sin(ty2)))/(((xd2*np.sin(ty2)*np.cos(tx2)**2 + zd2*np.cos(ty2)*np.cos(tx2) + xd2*np.sin(ty2)*np.sin(tx2)**2 - yd2*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) - (X*np.sin(ty2))/(np.cos(ty2)**2 + np.sin(ty2)**2) - (Z*np.cos(tx2)*np.cos(ty2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) + (Y*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2))*(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2)) - (f2x*np.cos(tx2)*np.cos(ty2)*((Y*(np.cos(tx2)*np.sin(tz2)*np.cos(ty2)**2 + np.cos(tx2)*np.sin(tz2)*np.sin(ty2)**2 + np.cos(tz2)*np.sin(tx2)*np.sin(ty2)))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) - (yd2*np.cos(tz2)*np.sin(tx2)*np.sin(ty2) - zd2*np.cos(tx2)*np.cos(tz2)*np.sin(ty2) + xd2*np.cos(tx2)**2*np.cos(ty2)*np.cos(tz2) + xd2*np.cos(ty2)*np.cos(tz2)*np.sin(tx2)**2 + yd2*np.cos(tx2)*np.cos(ty2)**2*np.sin(tz2) + yd2*np.cos(tx2)*np.sin(ty2)**2*np.sin(tz2) + zd2*np.cos(ty2)**2*np.sin(tx2)*np.sin(tz2) + zd2*np.sin(tx2)*np.sin(ty2)**2*np.sin(tz2))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) + (Z*(np.sin(tx2)*np.sin(tz2)*np.cos(ty2)**2 + np.sin(tx2)*np.sin(tz2)*np.sin(ty2)**2 - np.cos(tx2)*np.cos(tz2)*np.sin(ty2)))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) + (X*np.cos(ty2)*np.cos(tz2))/(np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(ty2)**2 + np.sin(ty2)**2*np.sin(tz2)**2)))/(((xd2*np.sin(ty2)*np.cos(tx2)**2 + zd2*np.cos(ty2)*np.cos(tx2) + xd2*np.sin(ty2)*np.sin(tx2)**2 - yd2*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) - (X*np.sin(ty2))/(np.cos(ty2)**2 + np.sin(ty2)**2) - (Z*np.cos(tx2)*np.cos(ty2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) + (Y*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2))**2*(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2))) + (V2 - V2d)*((f2y*np.cos(tx2)*np.cos(ty2)*((- xd2*np.sin(tz2)*np.cos(tx2)**2*np.cos(ty2) + yd2*np.cos(tz2)*np.cos(tx2)*np.cos(ty2)**2 + yd2*np.cos(tz2)*np.cos(tx2)*np.sin(ty2)**2 + zd2*np.sin(tz2)*np.cos(tx2)*np.sin(ty2) + zd2*np.cos(tz2)*np.cos(ty2)**2*np.sin(tx2) - xd2*np.sin(tz2)*np.cos(ty2)*np.sin(tx2)**2 + zd2*np.cos(tz2)*np.sin(tx2)*np.sin(ty2)**2 - yd2*np.sin(tz2)*np.sin(tx2)*np.sin(ty2))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) - (Y*(np.cos(tx2)*np.cos(ty2)**2*np.cos(tz2) - np.sin(tx2)*np.sin(ty2)*np.sin(tz2) + np.cos(tx2)*np.cos(tz2)*np.sin(ty2)**2))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) - (Z*(np.cos(tz2)*np.sin(tx2)*np.cos(ty2)**2 + np.cos(tz2)*np.sin(tx2)*np.sin(ty2)**2 + np.cos(tx2)*np.sin(tz2)*np.sin(ty2)))/(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2) + (X*np.cos(ty2)*np.sin(tz2))/(np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(ty2)**2 + np.sin(ty2)**2*np.sin(tz2)**2)))/(((xd2*np.sin(ty2)*np.cos(tx2)**2 + zd2*np.cos(ty2)*np.cos(tx2) + xd2*np.sin(ty2)*np.sin(tx2)**2 - yd2*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) - (X*np.sin(ty2))/(np.cos(ty2)**2 + np.sin(ty2)**2) - (Z*np.cos(tx2)*np.cos(ty2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) + (Y*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2))**2*(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2)) - (f2y*(np.cos(tz2)*np.sin(tx2)*np.cos(ty2)**2 + np.cos(tz2)*np.sin(tx2)*np.sin(ty2)**2 + np.cos(tx2)*np.sin(tz2)*np.sin(ty2)))/(((xd2*np.sin(ty2)*np.cos(tx2)**2 + zd2*np.cos(ty2)*np.cos(tx2) + xd2*np.sin(ty2)*np.sin(tx2)**2 - yd2*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) - (X*np.sin(ty2))/(np.cos(ty2)**2 + np.sin(ty2)**2) - (Z*np.cos(tx2)*np.cos(ty2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2) + (Y*np.cos(ty2)*np.sin(tx2))/(np.cos(tx2)**2*np.cos(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2 + np.cos(ty2)**2*np.sin(tx2)**2 + np.sin(tx2)**2*np.sin(ty2)**2))*(np.cos(tx2)**2*np.cos(ty2)**2*np.cos(tz2)**2 + np.cos(tx2)**2*np.cos(ty2)**2*np.sin(tz2)**2 + np.cos(tx2)**2*np.cos(tz2)**2*np.sin(ty2)**2 + np.cos(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2 + np.cos(ty2)**2*np.cos(tz2)**2*np.sin(tx2)**2 + np.cos(ty2)**2*np.sin(tx2)**2*np.sin(tz2)**2 + np.cos(tz2)**2*np.sin(tx2)**2*np.sin(ty2)**2 + np.sin(tx2)**2*np.sin(ty2)**2*np.sin(tz2)**2)));
        
            m1t = b1*m1t + (1-b1)*dx
            v1t = b2*v1t + (1-b2)*dx**2
            m2t = b1*m2t + (1-b1)*dy
            v2t = b2*v2t + (1-b2)*dy**2
            m3t = b1*m3t + (1-b1)*dz
            v3t = b2*v3t + (1-b2)*dz**2
            
            X = X - 0.02*m1t/(np.sqrt(v1t)+e1)
            Y = Y - 0.02*m2t/(np.sqrt(v2t)+e1)
            Z = Z - 0.02*m3t/(np.sqrt(v3t)+e1)'''
            
            X = 0
            Y = 0
            Z = 0
            
            if keyboard.is_pressed('Esc'):                
                print('stop thread 2')
                break 
        except:
            print('loading2...')
            sleep(1)

E = 0  
X = 0
Y = 0
Z = 0
u1 = 640
v1 = 360
u2 = 640 
v2 = 360


f1x   =  1462.41849*2.8*10**(-6)
f1y   =  1463.08546*2.8*10**(-6)
f2x   =  1462.72598*2.8*10**(-6)
f2y   =  1463.43693*2.8*10**(-6)

tx1 = -np.pi           -0.05138696
ty1 =                  0.01030638
tz1 =                  0.00112668
xd1 = 0.14258972
yd1 = -0.06799282
zd1 = 0.74980775

tx2 = -np.pi           -0.05800814
ty2 =                  0.00366197
tz2 =                  0.0021982
xd2 = 0.24177565
yd2 = -0.07471912
zd2 = 0.7462229    

m1t = 0
m2t = 0
m3t = 0
v1t = 0
v2t = 0
v3t = 0

b1 = 0.9
b2 = 0.999
e1 = 0.00000001

T_0_C1 = Rotation_matrix(tx1,ty1,tz1,xd1,yd1,zd1)
T_0_C2 = Rotation_matrix(tx2,ty2,tz2,xd2,yd2,zd2)    

cam1 = cv2.VideoCapture(1, cv2.CAP_DSHOW)
cam1.set(3, 1280)
cam1.set(4, 720)
# camera 2
cam2 = cv2.VideoCapture(2, cv2.CAP_DSHOW)
cam2.set(3, 1280)
cam2.set(4, 720)

cameraMatrix1 = np.array([[1.46241849e+03, 0.00000000e+00, 6.25636696e+02],
                         [0.00000000e+00 ,1.46308546e+03 ,3.67738551e+02],
                         [0.00000000e+00 ,0.00000000e+00 ,1.00000000e+00]])
dist1 = np.array([[ 9.09787429e-03  ,1.24968114e+00  ,2.09444620e-03 ,-4.34063921e-03  ,-4.43403610e+00]])

cameraMatrix2 = np.array([[1.46272598e+03, 0.00000000e+00, 6.32812182e+02],
                         [0.00000000e+00 ,1.46343693e+03 ,3.81650385e+02],
                         [0.00000000e+00 ,0.00000000e+00 ,1.00000000e+00]])
dist2 = np.array([[ 3.86456823e-02  ,1.41048057e+00  ,3.62502599e-03 ,-1.55372992e-03  ,-5.45009460e+00]])


if __name__ == '__main__':          
    
    thread_cam = threading.Thread(target=cam, args=('Thread-1', ))
    thread_cam.start()

    thread_process = threading.Thread(target=process, args=('Thread-2', ))
    thread_process.start()
    